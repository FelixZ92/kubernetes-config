apiVersion: batch/v1
kind: Job
metadata:
  namespace: keycloak
  name: init-keycloak-realm
spec:
  parallelism: 1
  template:
    spec:
      automountServiceAccountToken: false
      restartPolicy: Never
      securityContext:
        runAsUser: 65534
        runAsGroup: 65534
        runAsNonRoot: true
      containers:
        - name: keycloak-init
          image: registry.gitlab.com/felixz92/keycloak-init:v0.1.2
          imagePullPolicy: Always
          env:
            - name: KEYCLOAK_ENDPOINT
              value: http://keycloak-http/auth
            - name: KEYCLOAK_REALM
              value: master
            - name: KEYCLOAK_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: keycloak-admin-user
            - name: KEYCLOAK_PASS
              valueFrom:
                secretKeyRef:
                  key: password
                  name: keycloak-admin-user
          volumeMounts: # TODO client scope + client extra!
            - mountPath: /definitions/realms/k8s/realm
              name: k8s-realm-config
            - mountPath: /definitions/realms/k8s/client-scopes
              name: k8s-client-scope
            - mountPath: /definitions/realms/k8s/users/cluster-user
              name: k8s-cluster-user-config
            - mountPath: /definitions/realms/k8s/users/cluster-admin
              name: k8s-cluster-admin-user-config
            - mountPath: /definitions/realms/k8s/groups
              name: k8s-keycloak-group-config
            - mountPath: /definitions/realms/k8s/clients/k8s/definition
              name: k8s-client-config
            - mountPath: /definitions/realms/k8s/clients/k8s/secret
              name: k8s-client-secret

            - mountPath: /definitions/realms/applications/realm
              name: applications-realm-config
            - mountPath: /definitions/realms/applications/users/test-user
              name: applications-test-user-config

            - mountPath: /definitions/realms/applications/clients/ocis-web/definition
              name: ocis-web-client-config
            - mountPath: /definitions/realms/applications/clients/ocis-web/secret
              name: ocis-web-client-secret

            - mountPath: /definitions/realms/applications/clients/ocis-android/definition
              name: ocis-android-client-config
            - mountPath: /definitions/realms/applications/clients/ocis-android/secret
              name: ocis-android-client-secret
            - mountPath: /definitions/realms/applications/clients/ocis-ios/definition
              name: ocis-ios-client-config
            - mountPath: /definitions/realms/applications/clients/ocis-ios/secret
              name: ocis-ios-client-secret
            - mountPath: /definitions/realms/applications/clients/ocis-desktop/definition
              name: ocis-desktop-client-config
            - mountPath: /definitions/realms/applications/clients/ocis-desktop/secret
              name: ocis-desktop-client-secret

          resources:
            requests:
              cpu: 50m
              memory: 256Mi
            limits:
              cpu: 50m
              memory: 256Mi
      volumes:
        - name: k8s-realm-config
          configMap:
            name: k8s-realm-config
            defaultMode: 0755
        - name: k8s-cluster-user-config
          configMap:
            defaultMode: 0755
            name: k8s-cluster-user-config
        - name: k8s-cluster-admin-user-config
          configMap:
            defaultMode: 0755
            name: k8s-cluster-admin-user-config
        - name: k8s-client-scope
          configMap:
            defaultMode: 0755
            name: k8s-client-scope
        - name: k8s-client-config
          configMap:
            defaultMode: 0755
            name: k8s-client-config
        - name: k8s-keycloak-group-config
          configMap:
            defaultMode: 0755
            name: k8s-keycloak-group-config
        - name: k8s-client-secret
          secret:
            items:
              - key: secret
                path: secret
            secretName: oidc-secret
            defaultMode: 0755

        - name: applications-realm-config
          configMap:
            name: applications-realm-config
            defaultMode: 0755
        - name: applications-test-user-config
          configMap:
            defaultMode: 0755
            name: applications-test-user-config
        - name: ocis-web-client-config
          configMap:
            defaultMode: 0755
            name: ocis-web-client-config
        - name: ocis-web-client-secret
          secret:
            items:
              - key: secret
                path: secret
            secretName: ocis-web-client-secret
            defaultMode: 0755
        - name: ocis-android-client-config
          configMap:
            defaultMode: 0755
            name: ocis-android-client-config
        - name: ocis-android-client-secret
          secret:
            items:
              - key: secret
                path: secret
            secretName: ocis-android-client-secret
            defaultMode: 0755
        - name: ocis-ios-client-config
          configMap:
            defaultMode: 0755
            name: ocis-ios-client-config
        - name: ocis-ios-client-secret
          secret:
            items:
              - key: secret
                path: secret
            secretName: ocis-ios-client-secret
            defaultMode: 0755
        - name: ocis-desktop-client-config
          configMap:
            defaultMode: 0755
            name: ocis-desktop-client-config
        - name: ocis-desktop-client-secret
          secret:
            items:
              - key: secret
                path: secret
            secretName: ocis-desktop-client-secret
            defaultMode: 0755
