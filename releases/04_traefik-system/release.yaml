---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: traefik-system
  namespace: traefik-system
  annotations:
    fluxcd.io/automated: "false"
    fluxcd.io/tag.chart-image: semver:~v2.0
spec:
  releaseName: traefik-system
  chart:
    repository: https://felixz92.gitlab.io/charts
    name: traefik
    version: 0.4.2
  values:
    image:
      repository: traefik
      tag: v2.0
      pullPolicy: IfNotPresent
    resources:
      limits:
        cpu: 200m
        memory: 384Mi
      requests:
        cpu: 25m
        memory: 128Mi
    deployment:
      annotations:
        sidecar.jaegertracing.io/inject: "true"
    nodeSelector:
      app.kubernetes.io/ingress: traefik-system
    securityContext:
      capabilities:
        drop:
          - ALL
        add:
          - NET_BIND_SERVICE
    priorityClassName: infrastructure-critical
    acme:
      enabled: true
      email: sysadmin@zippelf.com
      staging: true
    kubernetes:
      namespaces:
        - default
        - kube-system
        - keycloak
        - monitoring
        - logging
        - traefik-system
        - kubernetes-dashboard
      ingressClass: traefik-system
    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: traefik-system
      hosts:
        - host: traefik-system.192.168.0.14.xip.io
          paths:
            - "/"
    persistence:
      enabled: true
      storageClass: "nfs-client"
      accessModes:
        - ReadWriteOnce
      size: 3Gi
      annotations: {}
    auth-config-job:
      enabled: true
      resources:
        limits:
          cpu: 20m
          memory: 128Mi
        requests:
          cpu: 10m
          memory: 64Mi

      keycloak:
        endpoint: http://keycloak-http.keycloak.svc
        realm: k8s-dev
        clientScope: k8s-cluster
        clientDefinition: |
          {
            "clientId": "traefik-dashboard",
            "rootUrl": "https://traefik-system.192.168.0.14.xip.io",
            "surrogateAuthRequired": false,
            "enabled": true,
            "clientAuthenticatorType": "client-secret",
            "redirectUris": [
              "https://traefik-system.192.168.0.14.xip.io/*"
            ],
            "webOrigins": [],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": false,
            "frontchannelLogout": false,
            "protocol": "openid-connect",
            "attributes": {
              "saml.assertion.signature": "false",
              "saml.force.post.binding": "false",
              "saml.multivalued.roles": "false",
              "saml.encrypt": "false",
              "saml.server.signature": "false",
              "saml.server.signature.keyinfo.ext": "false",
              "exclude.session.state.from.auth.response": "false",
              "saml_force_name_id_format": "false",
              "saml.client.signature": "false",
              "tls.client.certificate.bound.access.tokens": "false",
              "saml.authnstatement": "false",
              "display.on.consent.screen": "false",
              "saml.onetimeuse.condition": "false"
            },
            "authenticationFlowBindingOverrides": {},
            "fullScopeAllowed": true,
            "nodeReRegistrationTimeout": -1,
            "defaultClientScopes": [
              "web-origins",
              "role_list",
              "k8s-cluster",
              "roles",
              "profile",
              "email"
            ],
            "optionalClientScopes": [
              "address",
              "phone",
              "offline_access"
            ],
            "access": {
              "view": true,
              "configure": true,
              "manage": true
            }
          }
        protocolMapperDefinition: |
          {
            "name": "traefik-dashboard-audience",
            "protocol": "openid-connect",
            "protocolMapper": "oidc-audience-mapper",
            "consentRequired": false,
            "config": {
              "included.client.audience": "traefik-dashboard",
              "id.token.claim": "false",
              "access.token.claim": "true"
            }
          }
        userName: realm-admin
        passwordSecret:
          secretName: realm-admin-credentials
          secretKey: password
        clientSecret:
          secretName: traefik-dashboard-client
          secretKey: clientSecret
