---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: keycloak
  namespace: keycloak
  annotations:
    fluxcd.io/automated: "false"
spec:
  releaseName: keycloak
  chart:
    repository: https://codecentric.github.io/helm-charts
    name: keycloak
    version: 6.1.0
  values:
    init:
      image:
        repository: busybox
        tag: 1.31
        pullPolicy: IfNotPresent
      resources:
        limits:
          cpu: 10m
          memory: 32Mi
        requests:
          cpu: 10m
          memory: 32Mi
    clusterDomain: dev.local
    keycloak:
      replicas: 1
      image:
        repository: jboss/keycloak
        tag: 8.0.1
        pullPolicy: IfNotPresent
      enableServiceLinks: false
      restartPolicy: Always
      serviceAccount:
        create: true
      securityContext:
        fsGroup: 1000
      containerSecurityContext:
        runAsUser: 1000
        runAsNonRoot: true
      basepath: ""
      username: keycloak
      password: "" # TODO create sealed secret for this
      existingSecret: "keycloak-admin"
      existingSecretKey: password
      nodeSelector: {}
      priorityClassName: infrastructure-critical
      tolerations: []
      resources:
        limits:
          cpu: 500m
          memory: 1024Mi
        requests:
          cpu: 500m
          memory: 1024Mi

      podDisruptionBudget:
        minAvailable: 1

      persistence:
        deployPostgres: false
        dbVendor: postgres
        existingSecret: "keycloak-user.identity-pg.credentials.postgresql.acid.zalan.do"
        existingSecretKey: password
        dbName: keycloak
        dbHost: identity-pg
        dbPort: 5432
        dbUser: keycloak_user
    test:
      enabled: true
      image:
        repository: unguiculus/docker-python3-phantomjs-selenium
        tag: v1
        pullPolicy: IfNotPresent
      securityContext:
        fsGroup: 1000
      containerSecurityContext:
        runAsUser: 1000
        runAsNonRoot: true