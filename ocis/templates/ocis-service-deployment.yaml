{{ $releaseName := .Release.Name }}
{{- range $key, $value := .Values.services }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $releaseName }}-{{ $key }}
  labels:
    app.kubernetes.io/name: ocis
    app.kubernetes.io/component: ocis-{{ $key }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: ocis
      app.kubernetes.io/component: ocis-{{ $key }}
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ocis
        app.kubernetes.io/component: ocis-{{ $key }}
    spec:
      containers:
      {{- range $value.containers }}
        - name: {{ .name }}
          image: {{ $.Values.image }}
          command: ["ocis"]
          args: {{ .args }}
        {{- if .env }}
          env:
        {{- range .env }}
          - name: {{ .name }}
            value: {{ .value }}
        {{- end}}
        {{- end }}
      {{- end}}
{{/*      {{- if .volumes }}*/}}
{{/*      volumes:*/}}
{{/*      {{- range .volumes}}*/}}
{{/*        - name: {{ .name }}*/}}
{{/*        {{- if .configMap }}*/}}
{{/*          configMap:*/}}
{{/*            name: {{ .configMap.name }}*/}}
{{/*        {{- end }}*/}}
{{/*      {{- end}}*/}}
{{/*      {{- end }}*/}}
{{/*      {{- end }}*/}}
{{- /*
  because we're iterating over a bunch of objects and generating yaml, this needs to be valid. As long
  as we keep concatenating "---" at the end of each file, we're good. The convention is to use one tem-
  plate per deployment, but for our case that would bloat quite a bit. For the sake of readibility,
  we should look into take that approach. Check https://github.com/helm/charts/tree/master/stable/prometheus
  for reference.
*/}}
---
{{- end }}