apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: identity-pg
  namespace: keycloak
  labels:
    app.kubernetes.io/name: spilo
    app.kubernetes.io/instance: identity-pg
    team: identity
spec:
  teamId: "identity"
  volume:
    size: 2Gi
  numberOfInstances: 1
  users:
    # database owner
    keycloak:
      - superuser
      - createdb
    # role for application foo
    keycloak_user: []

  databases:
    keycloak: keycloak
  postgresql:
    version: "12"

  sidecars:
    - name: "exporter"
      image: "wrouesnel/postgres_exporter"
      ports:
        - name: exporter
          containerPort: 9187
          protocol: TCP
      resources:
        limits:
          cpu: 500m
          memory: 256M
        requests:
          cpu: 100m
          memory: 200M
      env:
        - name: "DATA_SOURCE_URI"
          value: "localhost/keycloak?sslmode=disable"
        - name: "DATA_SOURCE_USER"
          valueFrom:
            secretKeyRef:
              name: postgres.identity-pg.credentials.postgresql.acid.zalan.do
              key: username
        - name: "DATA_SOURCE_PASS"
          valueFrom:
            secretKeyRef:
              name: postgres.identity-pg.credentials.postgresql.acid.zalan.do
              key: password
