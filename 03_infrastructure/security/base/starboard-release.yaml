apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  name: aquasecurity
  namespace: flux-system
spec:
  interval: 10m
  url: https://aquasecurity.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: starboard
  namespace: starboard
spec:
  interval: 5m
  chart:
    spec:
      chart: starboard-operator
      version: '0.7.0'
      sourceRef:
        kind: HelmRepository
        name: aquasecurity
        namespace: flux-system
      interval: 10m
  values:
    kubeBench:
      imageRef: docker.io/aquasec/kube-bench:0.6.3

    polaris:
      imageRef: quay.io/fairwinds/polaris:4.0
      # resources resource requests and limits
      resources:
        requests:
          cpu: 50m
          memory: 50M
        limits:
          cpu: 300m
          memory: 300M
      config:
        checks:
          # reliability
          multipleReplicasForDeployment: ignore
          priorityClassNotSet: ignore
          # resources
          cpuRequestsMissing: warning
          cpuLimitsMissing: warning
          memoryRequestsMissing: warning
          memoryLimitsMissing: warning
          # images
          tagNotSpecified: danger
          pullPolicyNotAlways: ignore
          # healthChecks
          readinessProbeMissing: warning
          livenessProbeMissing: warning
          # networking
          hostNetworkSet: warning
          hostPortSet: warning
          # security
          hostIPCSet: danger
          hostPIDSet: danger
          notReadOnlyRootFilesystem: warning
          privilegeEscalationAllowed: danger
          runAsRootAllowed: warning
          runAsPrivileged: danger
          dangerousCapabilities: danger
          insecureCapabilities: warning
        exemptions:
          - controllerNames:
              - kube-apiserver
              - kube-proxy
              - kube-scheduler
              - etcd-manager-events
              - kube-controller-manager
              - kube-dns
              - etcd-manager-main
            rules:
              - hostPortSet
              - hostNetworkSet
              - readinessProbeMissing
              - livenessProbeMissing
              - cpuRequestsMissing
              - cpuLimitsMissing
              - memoryRequestsMissing
              - memoryLimitsMissing
              - runAsRootAllowed
              - runAsPrivileged
              - notReadOnlyRootFilesystem
              - hostPIDSet
          - controllerNames:
              - kube-flannel-ds
            rules:
              - notReadOnlyRootFilesystem
              - runAsRootAllowed
              - notReadOnlyRootFilesystem
              - readinessProbeMissing
              - livenessProbeMissing
              - cpuLimitsMissing
          - controllerNames:
              - cert-manager
            rules:
              - notReadOnlyRootFilesystem
              - runAsRootAllowed
              - readinessProbeMissing
              - livenessProbeMissing
          - controllerNames:
              - cluster-autoscaler
            rules:
              - notReadOnlyRootFilesystem
              - runAsRootAllowed
              - readinessProbeMissing
          - controllerNames:
              - vpa
            rules:
              - runAsRootAllowed
              - readinessProbeMissing
              - livenessProbeMissing
              - notReadOnlyRootFilesystem
          - controllerNames:
              - datadog
            rules:
              - runAsRootAllowed
              - readinessProbeMissing
              - livenessProbeMissing
              - notReadOnlyRootFilesystem
          - controllerNames:
              - nginx-ingress-controller
            rules:
              - privilegeEscalationAllowed
              - insecureCapabilities
              - runAsRootAllowed
          - controllerNames:
              - dns-controller
              - datadog-datadog
              - kube-flannel-ds
              - kube2iam
              - aws-iam-authenticator
              - datadog
              - kube2iam
            rules:
              - hostNetworkSet
          - controllerNames:
              - aws-iam-authenticator
              - aws-cluster-autoscaler
              - kube-state-metrics
              - dns-controller
              - external-dns
              - dnsmasq
              - autoscaler
              - kubernetes-dashboard
              - install-cni
              - kube2iam
            rules:
              - readinessProbeMissing
              - livenessProbeMissing
          - controllerNames:
              - aws-iam-authenticator
              - nginx-ingress-default-backend
              - aws-cluster-autoscaler
              - kube-state-metrics
              - dns-controller
              - external-dns
              - kubedns
              - dnsmasq
              - autoscaler
              - tiller
              - kube2iam
            rules:
              - runAsRootAllowed
          - controllerNames:
              - aws-iam-authenticator
              - nginx-ingress-controller
              - nginx-ingress-default-backend
              - aws-cluster-autoscaler
              - kube-state-metrics
              - dns-controller
              - external-dns
              - kubedns
              - dnsmasq
              - autoscaler
              - tiller
              - kube2iam
            rules:
              - notReadOnlyRootFilesystem
          - controllerNames:
              - cert-manager
              - dns-controller
              - kubedns
              - dnsmasq
              - autoscaler
              - insights-agent-goldilocks-vpa-install
              - datadog
            rules:
              - cpuRequestsMissing
              - cpuLimitsMissing
              - memoryRequestsMissing
              - memoryLimitsMissing
          - controllerNames:
              - kube2iam
              - kube-flannel-ds
            rules:
              - runAsPrivileged
          - controllerNames:
              - kube-hunter
            rules:
              - hostPIDSet
          - controllerNames:
              - polaris
              - kube-hunter
              - goldilocks
              - insights-agent-goldilocks-vpa-install
            rules:
              - notReadOnlyRootFilesystem
          - controllerNames:
              - insights-agent-goldilocks-controller
            rules:
              - livenessProbeMissing
              - readinessProbeMissing
          - controllerNames:
              - insights-agent-goldilocks-vpa-install
              - kube-hunter
            rules:
              - runAsRootAllowed

    conftest:
      # imageRef the image reference
      imageRef: docker.io/openpolicyagent/conftest:v0.25.0
      # resources resource requests and limits
      resources:
        requests:
          cpu: 50m
          memory: 50M
        limits:
          cpu: 300m
          memory: 300M

    aqua:
      # imageRef Aqua scanner image reference. The tag determines the version of the scanner binary executable and it must
      # be compatible with version of Aqua server.
      imageRef: docker.io/aquasec/scanner:5.3
      # serverURL the endpoint URL of Aqua management console
      serverURL:
      # username the Aqua management console username
      username:
      # password the Aqua management console password
      password:

    rbac:
      create: true
    serviceAccount:
      # Specifies whether a service account should be created.
      create: true
      annotations: { }
      # name specifies the name of the k8s Service Account. If not set and create is
      # true, a name is generated using the fullname template.
      name: ""

    podAnnotations: { }

    podSecurityContext: { }
    # fsGroup: 2000

    securityContext:
      privileged: false
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

    resources: { }
      # We usually recommend not to specify default resources and to leave this as a conscious
      # choice for the user. This also increases chances charts run on environments with little
      # resources, such as Minikube. If you do want to specify resources, uncomment the following
      # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
      # limits:
      #   cpu: 100m
      #   memory: 128Mi
      # requests:
    #   cpu: 100m
    #   memory: 128Mi

    nodeSelector: { }

    tolerations: [ ]

    affinity: { }
