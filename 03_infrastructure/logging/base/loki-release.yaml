apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: loki
  name: loki
  namespace: loki
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5400Mi
  storageClassName: local-path
  volumeMode: Filesystem

---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: loki
  namespace: loki
spec:
  interval: 5m
  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
  chart:
    spec:
      chart: loki
      version: '2.6.0'
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: loki
      interval: 10m
  values:
    affinity: { }

    ## StatefulSet annotations
    annotations: { }

    config:
      limits_config:
        reject_old_samples_max_age: 24h
      schema_config:
        configs:
          - from: 2020-10-24
            store: boltdb-shipper
            object_store: filesystem
            schema: v11
            index:
              prefix: index_
              period: 24h
      table_manager:
        retention_deletes_enabled: true
        retention_period: 72h

    nodeSelector:
      storage: local

    ## ref: https://kubernetes.io/docs/concepts/storage/persistent-volumes/
    ## If you set enabled as "True", you need :
    ## - create a pv which above 10Gi and has same namespace with loki
    ## - keep storageClassName same with below setting
    persistence:
      enabled: true
      existingClaim: loki

    # priorityClassName:

    replicas: 1

    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi

    serviceMonitor:
      enabled: true
      additionalLabels:
        monitoring: kube-prometheus-stack
