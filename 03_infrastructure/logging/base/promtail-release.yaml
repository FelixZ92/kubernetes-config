apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  name: grafana
  namespace: loki
spec:
  interval: 10m
  url: https://grafana.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: promtail
  namespace: loki
spec:
  interval: 5m
  chart:
    spec:
      chart: promtail
      version: '2.3.0'
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: loki
      interval: 10m
  values:
    loki:
      serviceName: "loki"  # Defaults to "${RELEASE}-loki" if not set

    pipelineStages:
      - cri: { }

    ## Pod Labels
    podLabels: { }

    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 128Mi

    # Custom scrape_configs to override the default ones in the configmap
    scrapeConfigs: [ ]

    # Custom scrape_configs together with the default ones in the configmap
    extraScrapeConfigs:
      - job_name: journal
        journal:
          path: /var/log/journal
          max_age: 12h
          labels:
            job: systemd-journal
        relabel_configs:
          - source_labels: [ '__journal__systemd_unit' ]
            target_label: 'unit'
          - source_labels: [ '__journal__hostname' ]
            target_label: 'hostname'

    # Extra volumes to scrape logs from
    volumes:
      - name: pods
        hostPath:
          path: /var/log/pods
      - name: containers
        hostPath:
          path: /var/log/containers
    # Custom volumes together with the default ones
    extraVolumes:
      - name: journal
        hostPath:
          path: /var/log/journal

    volumeMounts:
      - name: pods
        mountPath: /var/log/pods
        readOnly: true
      - name: containers
        mountPath: /var/log/containers
        readOnly: true

    # Custom volumeMounts together with the default ones
    extraVolumeMounts:
      - name: journal
        mountPath: /var/log/journal
        readOnly: true

    # Add extra Commandline args while starting up promtail.
    # more info : https://github.com/grafana/loki/pull/1530

    extraCommandlineArgs: [ ]
    # example:
    # extraCommandlineArgs:
    #   - -client.external-labels=hostname=$(HOSTNAME)

    serviceMonitor:
      enabled: true
      additionalLabels:
        monitoring: kube-prometheus-stack
