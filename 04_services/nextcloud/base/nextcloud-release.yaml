apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  name: nextcloud
  namespace: nextcloud
spec:
  interval: 10m
  url: https://nextcloud.github.io/helm/
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nextcloud
  namespace: nextcloud
spec:
  interval: 5m
  dependsOn:
    - name: keycloak
      namespace: keycloak
  chart:
    spec:
      chart: nextcloud
      version: '2.6.1'
      sourceRef:
        kind: HelmRepository
        name: nextcloud
        namespace: nextcloud
      interval: 10m
  postRenderers:
    - kustomize:
        patchesJson6902:
          - patch:
              - op: add
                path: /spec/template/spec/serviceAccountName
                value: nextcloud
            target:
              kind: Deployment
              name: nextcloud
          - patch:
              - op: add
                path: /spec/template/spec/securityContext
                value:
                  runAsUser: 65534
                  runAsGroup: 65534
            target:
              kind: Deployment
              name: nextcloud-metrics
          - patch:
              - op: add
                path: /spec/jobTemplate/spec/template/spec/securityContext
                value:
                  runAsUser: 100
                  runAsGroup: 101
            target:
              kind: CronJob
              name: nextcloud-cron

  values:
    image:
      repository: nextcloud
      tag: 19.0.3-apache

    lifecycle: { }
    # postStartCommand: []
    # preStopCommand: []

    nextcloud:
      host: nextcloud.${BASE_DOMAIN}
      ## Use an existing secret
      existingSecret:
        enabled: true
        secretName: nextcloud-admin-user
        usernameKey: username
        passwordKey: password
      #     smtpUsernameKey: smtp_username
      #     smtpPasswordKey: smtp_password
      mail:
        enabled: false
        fromAddress: user
        domain: domain.com
        smtp:
          host: domain.com
          secure: ssl
          port: 465
          authtype: LOGIN
          name: user
          password: pass

      configs:
        s3.config.php: |-
          <?php
          $CONFIG = array (
            'objectstore' => array(
              'class' => '\\OC\\Files\\ObjectStore\\S3',
              'arguments' => array(
                'bucket'     => 'nextcloud',
                'autocreate' => true,
                'hostname'   => getenv('S3_HOST'),
                'port'       => getenv('S3_PORT'),
                'key'        => getenv('S3_ACCESS_KEY'),
                'secret'     => getenv('S3_SECRET_KEY'),
                'region'     => getenv('S3_REGION'),
                'use_ssl'    => getenv('S3_USE_SSL'),
                'use_path_style' => true
              )
            )
          );

      extraEnv:
        - name: S3_HOST
          value: minio.minio.svc
        - name: S3_PORT
          value: "9000"
        - name: S3_REGION
          value: local
        - name: S3_USE_SSL
          value: "false"
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: nextcloud-s3-credentials
              key: accesskey
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: nextcloud-s3-credentials
              key: secretkey

    internalDatabase:
      enabled: false

    externalDatabase:
      enabled: true
      type: postgresql
      host: nextcloud-pg
      database: postgres
      existingSecret:
        enabled: false
        secretName: nextcloud-user.nextcloud-pg.credentials.postgresql.acid.zalan.do
        usernameKey: username
        passwordKey: password

    redis:
      enabled: false
      usePassword: true
      password: 'changeme'

    ## Cronjob to execute Nextcloud background tasks
    ## ref: https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/background_jobs_configuration.html#webcron
    ##
    cronjob:
      enabled: true
      image:
        repository: curlimages/curl
        tag: 7.76.1
      curlInsecure: true
      failedJobsHistoryLimit: 5
      successfulJobsHistoryLimit: 2
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 128Mi

    persistence:
      # Nextcloud Data (/var/www/html)
      enabled: true
      annotations: { }
      storageClass: "local-path"
      accessMode: ReadWriteOnce
      size: 8Gi

    resources:
      limits:
        cpu: 200m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

    ## Prometheus Exporter / Metrics
    ##
    metrics:
      enabled: true

      replicaCount: 1
      # The metrics exporter needs to know how you serve Nextcloud either http or https
      https: true
      timeout: 5s

      image:
        repository: xperimental/nextcloud-exporter
        tag: v0.3.0

      ## Metrics exporter resource requests and limits
      ## ref: http://kubernetes.io/docs/user-guide/compute-resources/
      ##
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi
