---
apiVersion: v1
kind: Service
metadata:
  name: ocis-metrics
  labels:
    app.kubernetes.io/name: ocis-web
    app.kubernetes.io/component: ocis-metrics
spec:
  selector:
    app.kubernetes.io/name: ocis-web
  ports:
    - port: 9104
      protocol: TCP
      name: metrics-web
      targetPort: metrics-web
    - port: 9114
      protocol: TCP
      name: metrics-ocs
      targetPort: metrics-ocs
    - port: 9119
      protocol: TCP
      name: metrics-webdav
      targetPort: metrics-webdav
    - port: 9129
      protocol: TCP
      name: metrics-glauth
      targetPort: metrics-glauth
    - port: 9134
      protocol: TCP
      name: metrics-idp
      targetPort: metrics-idp
    - port: 9141
      protocol: TCP
      name: metrics-s-f # storage-frontend
      targetPort: metrics-s-f # storage-frontend
    - port: 9143
      protocol: TCP
      name: metrics-s-g # storage-gateway
      targetPort: metrics-s-g # storage-gateway
    - port: 9145
      protocol: TCP
      name: metrics-s-s # storage-sharing
      targetPort: metrics-s-s # storage-sharing
    - port: 9147
      protocol: TCP
      name: metrics-s-a-b # storage-auth-basic
      targetPort: metrics-s-a-b # storage-auth-basic
    - port: 9149
      protocol: TCP
      name: metrics-s-a-be # storage-auth-bearer
      targetPort: metrics-s-a-be # storage-auth-bearer
    - port: 9151
      protocol: TCP
      name: metrics-s-sh # storage-sharing
      targetPort: metrics-s-sh # storage-sharing
    - port: 9156
      protocol: TCP
      name: metrics-s-h # storage-home
      targetPort: metrics-s-h # storage-home
    - port: 9159
      protocol: TCP
      name: metrics-s-u # storage-users
      targetPort: metrics-s-u # storage-users
    - port: 9179
      protocol: TCP
      name: metrics-s-p-l # storage-public-link
      targetPort: metrics-s-p-l # storage-public-link
    - port: 9189
      protocol: TCP
      name: metrics-t # thumbnails
      targetPort: metrics-t # thumbnails
    - port: 9194
      protocol: TCP
      name: metrics-set # settings
      targetPort: metrics-set # settings
    - port: 9205
      protocol: TCP
      name: metrics-proxy
      targetPort: metrics-proxy
    - port: 9217
      protocol: TCP
      name: metrics-s-m # storage-metadata
      targetPort: metrics-s-m # storage-metadata
    - port: 9224
      protocol: TCP
      name: metrics-oo # onlyoffice
      targetPort: metrics-oo # onlyoffice
    - port: 9460
      protocol: TCP
      name: metrics-store
      targetPort: metrics-store
  type: ClusterIP

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: ocis-metrics
    release: kube-prometheus-stack
  name: ocis
spec:
  endpoints:
    - path: /metrics
      honorLabels: true
      port: metrics-web
    - path: /metrics
      honorLabels: true
      port: metrics-ocs
    - path: /metrics
      honorLabels: true
      port: metrics-webdav
    - path: /metrics
      honorLabels: true
      port: metrics-glauth
    - path: /metrics
      honorLabels: true
      port: metrics-s-f # storage-frontend
    - path: /metrics
      honorLabels: true
      port: metrics-s-g # storage-gateway
    - path: /metrics
      honorLabels: true
      port: metrics-s-s # storage-sharing
    - path: /metrics
      honorLabels: true
      port: metrics-s-a-b # storage-auth-basic
    - path: /metrics
      honorLabels: true
      port: metrics-s-a-be #storage-auth-bearer
    - path: /metrics
      honorLabels: true
      port: metrics-s-sh # storage-sharing
    - path: /metrics
      honorLabels: true
      port: metrics-s-h # storage-home
    - path: /metrics
      honorLabels: true
      port: metrics-s-u # storage-users
    - path: /metrics
      honorLabels: true
      port: metrics-s-p-l # storage-public-link
    - path: /metrics
      honorLabels: true
      port: metrics-t #thumbnails
    - path: /metrics
      honorLabels: true
      port: metrics-set # settings
    - path: /metrics
      honorLabels: true
      port: metrics-proxy
    - path: /metrics
      honorLabels: true
      port: metrics-s-m # storage-metadata
    - path: /metrics
      honorLabels: true
      port: metrics-oo # onlyoffice
    - path: /metrics
      honorLabels: true
      port: metrics-store

  selector:
    matchLabels:
      app.kubernetes.io/name: ocis-web
      app.kubernetes.io/component: ocis-metrics
